image: docker:latest
services:
  - docker:dind

variables:
  WORK_DIR: ./
  BRANCH: staging
  REGISTRY: registry.gitlab.com/troydo42/gro-api

stages:
  - build
  - deploy

build job:
  stage: build
  script:
      - docker login -u troydo42 -p $PASSWORD registry.gitlab.com
      - docker build -t $REGISTRY .
      - docker push $REGISTRY

deploy job:
  stage: deploy
  script:
      - docker login -u troydo42 -p $PASSWORD registry.gitlab.com
      - docker pull $REGISTRY
      - docker run --name=$BRANCH -d -p 80:8000 -i $REGISTRY 
    
